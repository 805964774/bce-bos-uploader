<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>百度开放云文件上传演示</title>
    <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
    <!--[if lt IE 10]><script src="bower_components/moxie/bin/js/moxie.min.js"></script><![endif]-->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/humanize/humanize.js"></script>
    <script src="https://cdn.bdstatic.com/bce-bos-uploader-lite/1.0.4/bce-bos-uploader-lite.min.js"></script>
    <script src="webuploader/webuploader.js"></script>
    <link rel="stylesheet" type="text/css" href="webuploader/webuploader.css" />
    <style type="text/css">
    .empty,
    .f-status {
        text-align: center;
    }
    .f-progress {
        text-align: right;
    }
    .btn-file {
        position: relative;
        overflow: hidden;
    }
    .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: inherit;
        display: block;
    }
    table th,
    .f-progress,
    .f-size {
        white-space: nowrap;
    }
    .f-name .alert-danger {
        padding: 0 5px;
        margin: 0;
    }
    tr.ignored {
      text-decoration: line-through;
      color: gray;
    }
    .table > tbody > tr > td.f-progress {
        vertical-align: middle;
    }
    .progress {
        margin-bottom: 0;
        height: 10px;
    }
    .progress-bar {
      -webkit-transition: none;
      transition: none;
    }
    .logo {
      padding: 12px 0;
      margin: 20px 0;
      background: url(resources/logo2x.png) left center no-repeat;
      padding-left: 190px;
    }
    .logo h2 {
      margin: 5px 0;
      font-size: 24px;
    }
    .webuploader-container {
      float: left;
      margin-right: 10px;
    }
    .webuploader-pick {
      padding: 7px 15px;
    }
    </style>
  </head>
  <body>
    <a id="forkme" href="https://github.com/leeight/bce-bos-uploader-lite"><img style="position: absolute; top: 0; right: 0; border: 0;" src="forkme_right_gray.png" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="logo"><h2>文件上传演示</h2></div>
          <div class="alert alert-warning" role="alert">
            文件自动上传到 bce-bos-uploader 这个bucket，后台会定期清理，请勿上传重要文件。
          </div>
          <form class="form-inline">
            <div class="form-group">
              <span id="picker">
                <span class="glyphicon glyphicon-paperclip"></span> 选择50Gb以内的文件
              </span>
              <!--button id="gen-random-file" class="btn btn-default">生成随机文件</button-->
              <button type="submit" class="btn btn-success" disabled>开始上传</button>
              <span class="network-speed"></span>
            </div>
          </form>
          <br />
          <div id="thelist" class="uploader-list"></div>
          <table class="table table-bordered">
            <colgroup>
              <col width="50px" />
              <col width="50px" />
              <col width="180px" />
              <col width="60px" />
              <col width="100px" />
              <col width="100px" />
            </colgroup>
            <thead>
              <tr>
                <th>#</th>
                <th>状态</th>
                <th>进度</th>
                <th>大小</th>
                <th>耗时(s)</th>
                <th>操作</th>
                <th>文件名</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="empty">请选择文件...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script>
    var __isEmpty = true;
    var AK = '07e08ee9530d400f83ff8a82a30d5f71';
    var SK = 'fde2d76826f244738e9924c66796b3a8';
    var BOS_ENDPOINT = 'http://bce-bos-uploader.cdn.bcebos.com';
    var Uploader = WebUploader.Uploader;

    function getDefaultCssProgress() {
      return '<div class="progress">' +
             '  <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">'
             '  </div>' +
             '</div>';
    }

    function getKey(name) {
      var date = new Date();
      var year = date.getFullYear();

      var month = date.getMonth() + 1;
      if (month < 10) {
        month = '0' + month;
      }
      var day = date.getDate();
      if (day < 10) {
        day = '0' + day;
      }

      var key = '/' + year + '/' + month + '/' + day + '/' + encodeURIComponent(name);

      return key;
    }

    function generateAuthorization(method, resource, params, headers, timestamp, expirationInSeconds, headersToSign) {
      var auth = new baidubce.sdk.Auth(AK, SK);
      return auth.generateAuthorization(method, resource, params, headers, timestamp, expirationInSeconds, headersToSign);
    }


    Uploader.register({
      name: 'bos',  // 随便取个名字，后续要禁用或者卸载这个扩充(hook)，需要用到这个名字。
      // InitiateMultipartUpload
      'before-send-file': function(file) {
        var method = 'POST';
        var resource = getKey(file.name);
        var params = {'uploads': ''};
        var xbceDate = new Date().toISOString().replace(/\.\d+Z$/, 'Z');
        var host = BOS_ENDPOINT.replace(/https?:\/\//, '');
        var timestamp = new Date().getTime() / 1000;
        var expirationInSeconds = 0;
        var headersToSign = ['x-bce-date', 'host'];
        var headers_ = {
            'x-bce-date': xbceDate,
            'host': host
        };
        var authorization = generateAuthorization(method, resource, params, headers_, timestamp, expirationInSeconds, headersToSign);
        var headers = {};
        headers['authorization'] = authorization;
        headers['x-bce-date'] = xbceDate;

        var deferred = WebUploader.Deferred();
        file.startAt = Date.now();
        $.ajax({
          url: BOS_ENDPOINT + resource + '?uploads',
          method: method,
          headers: headers
        }).done(function(ret) {
          file.bos = ret;
          deferred.resolve(file);
        });

        return deferred.promise();
      },

      'before-send': function(block) {
        var method = 'PUT';
        var resource = getKey(block.file.name);
        var params = {'partNumber': block.chunk + 1, uploadId: block.file.bos.uploadId};
        var xbceDate = new Date().toISOString().replace(/\.\d+Z$/, 'Z');
        var host = BOS_ENDPOINT.replace(/https?:\/\//, '');
        var timestamp = new Date().getTime() / 1000;
        var expirationInSeconds = 0;
        var headersToSign = ['x-bce-date', 'host'];
        var headers_ = {
            'x-bce-date': xbceDate,
            'host': host
        };
        var authorization = generateAuthorization(method, resource, params, headers_, timestamp, expirationInSeconds, headersToSign);
        var headers = {};
        headers['authorization'] = authorization;
        headers['x-bce-date'] = xbceDate;

        block.options = {
          method: method,
          server: BOS_ENDPOINT + resource + '?partNumber=' + params.partNumber + '&uploadId=' + params.uploadId,
          headers: headers
        };
      },

      'after-send-file': function(file) {
        var blocks = file.blocks;
        var parts = [];

        $.each(blocks, function(k, v) {
          parts.push({
            partNumber: v.chunk + 1,
            eTag: v.response._headers.etag.replace(/^"|"$/g, "")
          });
        });

        var method = 'POST';
        var resource = getKey(file.name);
        var params = {'uploadId': file.bos.uploadId};
        var xbceDate = new Date().toISOString().replace(/\.\d+Z$/, 'Z');
        var host = BOS_ENDPOINT.replace(/https?:\/\//, '');
        var timestamp = new Date().getTime() / 1000;
        var expirationInSeconds = 0;
        var headersToSign = ['x-bce-date', 'host'];
        var headers_ = {
            'x-bce-date': xbceDate,
            'host': host
        };
        var authorization = generateAuthorization(method, resource, params, headers_, timestamp, expirationInSeconds, headersToSign);
        var headers = {};
        headers['authorization'] = authorization;
        headers['x-bce-date'] = xbceDate;

        return $.ajax({
          url: BOS_ENDPOINT + resource + '?uploadId=' + params.uploadId,
          method: method,
          headers: headers,
          dataType: 'json',
          data: JSON.stringify({parts: parts}),
          contentType: 'application/json; charset=utf-8',
        });
      }
    });


    var uploader = new WebUploader.create({
      pick: '#picker',
      resize: false,
      compress: false,
      sendAsBinary: true,
      attachInfoToQuery: false,
      chunked: true,
      method: 'PUT'
    });
    uploader.on('fileQueued', function (file) {
      var files = [file];
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var id = file.id;
        var html = '<tr id="' + id + '">'
                    + '<td class="f-id">' + (0) + '</td>'
                    + '<td class="f-status"><span class="glyphicon glyphicon-record"></span></td>'
                    + '<td class="f-progress">' + getDefaultCssProgress() + '</td>'
                    + '<td class="f-size">' + (humanize.filesize(file.size)) + '</td>'
                    + '<td class="f-time">-</td>'
                    + '<td class="f-actions"><a href="javascript:;" data-cmd="abort" data-fid="' + file.id + '">取消</a></td>'
                    + '<td class="f-name">' + (file.name) + '</td>'
                    + '</tr>';
        if (__isEmpty) {
          __isEmpty = false;
          $('table tbody').html(html);
          $('table').on('click', '.f-actions a', function (e) {
            var fid = $(e.target).data('fid');
            var cmd = $(e.target).data('cmd');
            if (cmd === 'abort') {
              uploader.remove(fid);
            }
          });
        }
        else {
          $('table tbody').append(html);
        }
        $('button[type=submit]').attr('disabled', false);
      }
    });

    uploader.on('uploadProgress', function (file, percentage) {
      $('#' + file.id + ' .f-progress .progress-bar').css('width', (percentage * 100).toFixed(2) + '%');
    });

    uploader.on('uploadSuccess', function (file) {
      var tr = $('#' + file.id);

      var duration = ((Date.now() - file.startAt) / 1000).toFixed(2);
      tr.find('.f-actions').empty();
      tr.find('.f-progress').html('<span class="glyphicon glyphicon-ok"></span>');
      tr.find('.f-time').text(duration + '秒');
    });

    uploader.on('uploadError', function (file) {
    });

    uploader.on('uploadComplete', function (file) {
    });

    $('button[type=submit]').click(function () {
      uploader.upload();
      return false;
    });
    </script>
  </body>
</html>

